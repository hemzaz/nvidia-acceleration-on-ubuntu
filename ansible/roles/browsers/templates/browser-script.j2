#!/usr/bin/env bash
# Launch script for {{ browser_name }} with hardware acceleration.
# Generated by Ansible

# Define browser executable path
EXECCMD={{ browser_executable }}

# Verify executable exists and is executable
if [[ ! -x "$EXECCMD" ]]; then
    echo "ERROR: cannot access '$EXECCMD': No such executable"
    exit 1
fi

# Handle version check
if [[ "$1" == "--version" ]]; then
    exec "$EXECCMD" --version
fi

# Set hardware acceleration environment variables
# Only for X11 session with NVIDIA GPU and VDPAU driver
if [[ "$XDG_SESSION_TYPE" != "wayland" ]]; then
    if [[ -n "$(lsmod | grep nvidia_drm 2>/dev/null)" && -f {{ vdpau_driver_path }} ]]; then
        # The VDPAU-backend driver works in x11 only
        # Hardware acceleration may not work consistently in all browsers
        export LIBVA_DRIVERS_PATH=/usr/local/lib/dri:/usr/lib/x86_64-linux-gnu/dri
        export LIBVA_DRIVER_NAME=vdpau
        echo "Hardware acceleration enabled (VDPAU driver)"
    elif [[ -n "$(lsmod | grep nvidia_drm 2>/dev/null)" && -f {{ nvdec_driver_path }} ]]; then
        # The NVDEC driver works in both x11 and wayland
        export LIBVA_DRIVERS_PATH=/usr/local/lib/dri:/usr/lib/x86_64-linux-gnu/dri
        export LIBVA_DRIVER_NAME=nvdec
        echo "Hardware acceleration enabled (NVDEC driver)"
    else
        echo "Hardware acceleration not available (NVIDIA driver or VA-API driver not found)"
    fi
fi

# Calculate display scaling factor
# Using GNOME? Run gnome-tweaks > Fonts > Scaling Factor
# Scale Factor is problematic on Ozone-Wayland; ignores force argument
# Refer to: https://bugs.chromium.org/p/chromium/issues/detail?id=910797
SCALE_FACTOR=$(
    xrdb -query Xft.dpi 2>/dev/null | awk '/^Xft.dpi:/ {
        printf("%.9f", $2 / 96)
    }'
)

# Set default scale factor if none detected
if [[ -z "$SCALE_FACTOR" ]]; then
    SCALE_FACTOR="1.000000000"
fi

# Set display server specific options
if [[ "$XDG_SESSION_TYPE" == "wayland" ]]; then
    GL="egl"
    OZ="--ozone-platform-hint=auto"
    SF=""  # Scale Factor does not work in Wayland
    echo "Wayland session detected"
else
    GL="desktop"
    OZ=""
    SF="--high-dpi-support=1 --force-device-scale-factor=$SCALE_FACTOR"
    echo "X11 session detected, scale factor: $SCALE_FACTOR"
fi

{% if browser_type == 'chromium' %}
# Set acceleration flags for Chromium-based browsers
ACCEL_FLAGS="--disable-features=UseChromeOSDirectVideoDecoder --disable-gpu-vsync \
    --disable-font-subpixel-positioning --disable-direct-composition \
    --enable-features=VaapiVideoDecoder --enable-smooth-scrolling \
    --enable-accelerated-2d-canvas --enable-gpu-rasterization \
    --enable-zero-copy --use-gl=$GL"

# Launch browser with all needed flags
# Opt-in: change to --enable-font-subpixel-positioning on HiDPI display
echo "Launching {{ browser_display_name }} with hardware acceleration..."
exec "$EXECCMD" --window-size=1213,1004 $SF $OZ $ACCEL_FLAGS "$@" > /dev/null 2>&1 &
{% elif browser_type == 'firefox' %}
# Set acceleration flags for Firefox
# Firefox supports different set of flags
MOZ_FLAGS="MOZ_X11_EGL=1 MOZ_WEBRENDER=1 MOZ_ACCELERATED=1"

# Launch browser with all needed flags
echo "Launching {{ browser_display_name }} with hardware acceleration..."
exec $MOZ_FLAGS "$EXECCMD" "$@" > /dev/null 2>&1 &
{% else %}
# Set acceleration flags for other browsers
ACCEL_FLAGS="--disable-gpu-vsync --enable-smooth-scrolling \
    --enable-accelerated-2d-canvas --enable-gpu-rasterization"

# Launch browser with all needed flags
echo "Launching {{ browser_display_name }} with hardware acceleration..."
exec "$EXECCMD" $ACCEL_FLAGS "$@" > /dev/null 2>&1 &
{% endif %}