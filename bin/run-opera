#!/bin/bash
# Launch script for Opera.

EXECCMD=/usr/bin/opera

if [[ ! -x "$EXECCMD" ]]; then
    echo "ERROR: cannot access '$EXECCMD': No such executable"
    exit 1
fi

# Do not enable #ignore-gpu-blocklist for NVIDIA graphics.
# It may cause extra CPU utilization in Wayland, during video playback.

if [[ "$XDG_SESSION_TYPE" = "wayland" ]]; then
    GL=egl
else
    GL=desktop
    if [[ -f /usr/bin/nvidia-settings && -f /usr/local/lib/dri/vdpau_drv_video.so ]]
    then
        # The VDPAU-backend driver works in x11 only.
        export LIBVA_DRIVERS_PATH=/usr/local/lib/dri:/usr/lib/x86_64-linux-gnu/dri
        export LIBVA_DRIVER_NAME=vdpau
    fi
fi

# Using GNOME? Run gnome-tweaks > Fonts > Scaling Factor

SCALE_FACTOR=$(
    xrdb -query Xft.dpi | awk '/^Xft.dpi:/ {
        printf("%.9f", $2 / 96)
    }'
)

# Scale Factor is problematic on Ozone-Wayland; ignores force argument
# Refer to: https://bugs.chromium.org/p/chromium/issues/detail?id=910797

SF="--high-dpi-support=1 --force-device-scale-factor=$SCALE_FACTOR" OZ=""

if [[ "$XDG_SESSION_TYPE" = "wayland" ]]; then
    # Do not care about Scale Factor working; prefer Chrome for playing videos.
    # OZ="--ozone-platform-hint=auto" SF=""   # Use OzonePlatform and clear SF.
    # Need Scale Factor on HiDPI display; prefer Firefox for playing videos.
      OZ="--disable-features=UseOzonePlatform"   # Disable Ozone.
fi

# Opt-in: change to --enable-font-subpixel-positioning on HiDPI display

exec "$EXECCMD" --window-size=1213,952 $SF $OZ \
    --disable-features=UseChromeOSDirectVideoDecoder --disable-gpu-vsync \
    --disable-font-subpixel-positioning --disable-direct-composition \
    --enable-features=VaapiVideoDecoder --enable-smooth-scrolling \
    --enable-accelerated-2d-canvas --enable-gpu-rasterization \
    --enable-zero-copy --use-gl=$GL $* &> /dev/null &

